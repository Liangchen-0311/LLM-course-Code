
# HyDEçŸ¥è¯†æ£€ç´¢å·¥å…·
class HyDEKnowledgeRetrievalTool(BaseTool):
    name: str = "hyde_knowledge_retrieval"
    description: str = "ä½¿ç”¨HyDEæŠ€æœ¯è¿›è¡ŒçŸ¥è¯†æ£€ç´¢ï¼Œé€šè¿‡ç”Ÿæˆå‡è®¾æ–‡æ¡£æ¥å¢žå¼ºæ£€ç´¢æ•ˆæžœã€‚"

    model: ClassVar = SentenceTransformer(r"C:/Users/bbk/.cache/huggingface/hub/models--sentence-transformers--all-mpnet-base-v2/snapshots/12e86a3c702fc3c50205a8db88f0ec7c0b6b94a0/")
    index: ClassVar = faiss.read_index('10_nl2sql/mynl2sql/v1/knowledge_faiss.index')
    corpus: ClassVar = np.load('10_nl2sql/mynl2sql/v1/knowledge_corpus.npy', allow_pickle=True)

    def _generate_hypothetical_document(self, query: str) -> str:
        hypothetical_prompt = f"""
        åŸºäºŽä»¥ä¸‹æŸ¥è¯¢ï¼Œç”Ÿæˆä¸€ä¸ªå‡è®¾çš„æ–‡æ¡£ç‰‡æ®µï¼Œè¿™ä¸ªç‰‡æ®µåº”è¯¥åŒ…å«å›žç­”è¯¥æŸ¥è¯¢æ‰€éœ€çš„ä¿¡æ¯ï¼š

        æŸ¥è¯¢ï¼š{query}

        è¯·ç”Ÿæˆä¸€ä¸ªåŒ…å«ç›¸å…³ä¿¡æ¯çš„å‡è®¾æ–‡æ¡£ç‰‡æ®µï¼š
        """
        
        try:
            response = llm.invoke(hypothetical_prompt)
            return response.content.strip()
        except Exception as e:
            return f"å…³äºŽ{query}çš„ç›¸å…³ä¿¡æ¯ï¼šè¿™æ˜¯ä¸€ä¸ªå‡è®¾çš„æ–‡æ¡£ç‰‡æ®µï¼ŒåŒ…å«ä¸ŽæŸ¥è¯¢ç›¸å…³çš„å…³é”®ä¿¡æ¯ã€‚"

    def _run(self, query: str) -> str:
        try:
            hypothetical_doc = self._generate_hypothetical_document(query)
            hypothetical_vec = self.model.encode([hypothetical_doc])
            D_hypothetical, I_hypothetical = self.index.search(
                np.array(hypothetical_vec).astype('float32'), k=3
            )
            
            query_vec = self.model.encode([query])
            D_query, I_query = self.index.search(
                np.array(query_vec).astype('float32'), k=3
            )
            
            all_indices = list(set(I_hypothetical[0].tolist() + I_query[0].tolist()))
            results = [self.corpus[idx] for idx in all_indices[:5]]
            
            output = f"ðŸ” HyDEæ£€ç´¢ç»“æžœ (æŸ¥è¯¢: {query})\n"
            output += f"ðŸ“„ ç”Ÿæˆçš„å‡è®¾æ–‡æ¡£: {hypothetical_doc[:200]}...\n\n"
            output += "ðŸ“š æ£€ç´¢åˆ°çš„çŸ¥è¯†ç‰‡æ®µ:\n"
            output += "\n".join([f"ã€çŸ¥è¯†ç‰‡æ®µ{i+1}ã€‘{text}" for i, text in enumerate(results)])
            
            return output
            
        except Exception as e:
            query_vec = self.model.encode([query])
            D, I = self.index.search(np.array(query_vec).astype('float32'), k=3)
            results = [self.corpus[idx] for idx in I[0]]
            return f"âš ï¸ HyDEæ£€ç´¢å¤±è´¥ï¼Œä½¿ç”¨åŽŸå§‹æ£€ç´¢æ–¹æ³•:\n" + "\n".join([f"ã€çŸ¥è¯†ç‰‡æ®µ{i+1}ã€‘{text}" for i, text in enumerate(results)])

    async def _arun(self, query: str) -> str:
        return self._run(query)




    # ä½¿ç”¨HyDEæ£€ç´¢ç›¸å…³çŸ¥è¯†
    hyde_tool = HyDEKnowledgeRetrievalTool()
    knowledge_result = hyde_tool._run(user_query)
    
